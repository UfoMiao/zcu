# 8. 集成与部署架构

## 8.1 CI/CD流水线设计

### 8.1.1 自动化构建流程

```yaml
# .github/workflows/ci.yml
name: ZCU CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run type check
        run: pnpm typecheck
      
      - name: Run linting
        run: pnpm lint
      
      - name: Run unit tests
        run: pnpm test:coverage
      
      - name: Run integration tests
        run: pnpm test:integration
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info

  e2e-test:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build application
        run: pnpm build
      
      - name: Run E2E tests
        run: pnpm test:e2e

  build:
    runs-on: ubuntu-latest
    needs: [test, e2e-test]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm build
      
      - name: Package CLI binary
        run: pnpm package
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: zcu-build
          path: |
            dist/
            bin/
            packages/

  release:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build and package
        run: pnpm build && pnpm package
      
      - name: Publish to npm
        run: pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: ZCU ${{ github.ref }}
          body: |
            ## 新功能 What's New
            
            ### ✨ 功能增强 Features
            - 改进的快照管理界面
            - 增强的AI工作空间隔离
            - 优化的冲突解决机制
            
            ### 🐛 错误修复 Bug Fixes  
            - 修复大文件处理性能问题
            - 解决跨平台兼容性问题
            
            ### 🔧 技术改进 Technical Improvements
            - 升级依赖项版本
            - 优化构建流程
            - 改进错误处理
            
            ## 安装和升级 Installation & Upgrade
            
            ```bash
            # 全新安装
            npm install -g zcu
            
            # 从旧版本升级
            npm update -g zcu
            ```
            
            ## 破坏性变更 Breaking Changes
            
            无破坏性变更
            
            ## 完整变更日志
            
            查看 [CHANGELOG.md](CHANGELOG.md) 获取详细变更信息。
```

### 8.1.2 多平台打包策略

```typescript
// build.config.ts - unbuild配置
export default defineBuildConfig([
  // CLI核心包
  {
    name: 'zcu-core',
    entries: ['src/index'],
    outDir: 'dist',
    clean: true,
    declaration: true,
    rollup: {
      emitCJS: true,
      esbuild: {
        target: 'node16'
      }
    },
    externals: [
      'leveldown',
      'fsevents' // macOS特定依赖
    ]
  },
  
  // CLI二进制
  {
    name: 'zcu-cli',
    entries: ['src/cli'],
    outDir: 'bin',
    clean: false,
    rollup: {
      emitCJS: true,
      inlineDynamicImports: true,
      esbuild: {
        target: 'node16',
        banner: '#!/usr/bin/env node'
      }
    }
  },
  
  // Web Dashboard
  {
    name: 'zcu-web',
    entries: ['src/web/index'],
    outDir: 'dist/web',
    rollup: {
      emitCJS: false,
      esbuild: {
        target: 'es2020',
        format: 'esm'
      }
    }
  }
])

// package.config.ts - 多平台打包
export const packageConfig = {
  targets: [
    {
      platform: 'win32',
      arch: 'x64',
      output: 'zcu-win-x64.exe'
    },
    {
      platform: 'darwin', 
      arch: 'x64',
      output: 'zcu-mac-x64'
    },
    {
      platform: 'darwin',
      arch: 'arm64', 
      output: 'zcu-mac-arm64'
    },
    {
      platform: 'linux',
      arch: 'x64',
      output: 'zcu-linux-x64'
    }
  ],
  
  // 平台特定配置
  platformSpecific: {
    win32: {
      icon: 'assets/icon.ico',
      productName: 'ZCU - Z Claude Undo',
      productDescription: 'Advanced undo/redo for Claude Code'
    },
    darwin: {
      icon: 'assets/icon.icns',
      category: 'public.app-category.developer-tools'
    },
    linux: {
      icon: 'assets/icon.png',
      desktop: {
        Name: 'ZCU',
        Comment: 'Advanced undo/redo for Claude Code',
        Categories: 'Development;'
      }
    }
  }
}
```

## 8.2 部署策略

### 8.2.1 容器化部署

```dockerfile
# Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

# 复制包管理文件
COPY package.json pnpm-lock.yaml ./
COPY .npmrc ./

# 安装依赖
RUN npm install -g pnpm
RUN pnpm install --frozen-lockfile

# 复制源代码
COPY . .

# 构建应用
RUN pnpm build

# 生产镜像
FROM node:18-alpine AS runtime

WORKDIR /app

# 安装生产依赖
COPY package.json pnpm-lock.yaml ./
RUN npm install -g pnpm
RUN pnpm install --prod --frozen-lockfile

# 复制构建产物
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/bin ./bin

# 创建非root用户
RUN addgroup -g 1001 -S zcu
RUN adduser -S zcu -u 1001
USER zcu

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node bin/zcu.mjs --health-check

EXPOSE 3001

CMD ["node", "bin/zcu.mjs", "serve"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  zcu-server:
    build: .
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - ZCU_DATA_DIR=/data
      - ZCU_LOG_LEVEL=info
    volumes:
      - zcu_data:/data
      - zcu_logs:/app/logs
    healthcheck:
      test: ["CMD", "node", "bin/zcu.mjs", "--health-check"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    
  # 可选：Redis缓存
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    restart: unless-stopped
    
  # 可选：监控
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    restart: unless-stopped

volumes:
  zcu_data:
  zcu_logs:
  redis_data:
  prometheus_data:
```

### 8.2.2 云服务部署

```typescript
// deploy/aws-lambda.ts - Lambda部署配置
export const lambdaConfig = {
  functionName: 'zcu-api-handler',
  runtime: 'nodejs18.x',
  handler: 'dist/lambda.handler',
  memorySize: 1024,
  timeout: 30,
  
  environment: {
    NODE_ENV: 'production',
    ZCU_DATA_BUCKET: 'zcu-data-bucket',
    ZCU_LOG_LEVEL: 'info'
  },
  
  layers: [
    'arn:aws:lambda:us-east-1:123456789012:layer:zcu-dependencies:1'
  ],
  
  vpc: {
    securityGroupIds: ['sg-12345678'],
    subnetIds: ['subnet-12345678', 'subnet-87654321']
  }
}

// next.config.js - Next.js 15配置（UnoCSS集成）
import UnoCSS from '@unocss/next'

/** @type {import('next').NextConfig} */
const nextConfig = {
  // React 19 和 Next.js 15 新特性
  experimental: {
    // appDir 在 Next.js 15 中已稳定，不再需要
    serverExternalPackages: ['@zcu/core'], // 更新的配置名
    turbo: {
      rules: {
        '*.svg': {
          loaders: ['@svgr/webpack'],
          as: '*.js',
        },
      },
    },
  },
  transpilePackages: ['@zcu/shared'],
  env: {
    ZCU_API_URL: process.env.ZCU_API_URL || 'http://localhost:3001',
  },
  // React 19 优化
  compiler: {
    removeConsole: process.env.NODE_ENV === 'production',
  },
}

export default UnoCSS(nextConfig)

// deploy/vercel.ts - Vercel部署配置  
export const vercelConfig = {
  name: 'zcu-web-dashboard',
  version: 2,
  
  builds: [
    {
      src: 'src/web/**/*',
      use: '@vercel/next'
    },
    {
      src: 'src/api/**/*',
      use: '@vercel/node'
    }
  ],
  
  routes: [
    {
      src: '/api/(.*)',
      dest: '/src/api/$1'
    },
    {
      src: '/(.*)',
      dest: '/src/web/$1'
    }
  ],
  
  env: {
    ZCU_API_URL: 'https://api.zcu.dev',
    NODE_ENV: 'production',
    UNOCSS_MODE: 'production'
  }
}
```

---
