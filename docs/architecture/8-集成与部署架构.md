# 8. é›†æˆä¸éƒ¨ç½²æ¶æ„

## 8.1 CI/CDæµæ°´çº¿è®¾è®¡

### 8.1.1 è‡ªåŠ¨åŒ–æ„å»ºæµç¨‹

```yaml
# .github/workflows/ci.yml
name: ZCU CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run type check
        run: pnpm typecheck
      
      - name: Run linting
        run: pnpm lint
      
      - name: Run unit tests
        run: pnpm test:coverage
      
      - name: Run integration tests
        run: pnpm test:integration
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info

  e2e-test:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build application
        run: pnpm build
      
      - name: Run E2E tests
        run: pnpm test:e2e

  build:
    runs-on: ubuntu-latest
    needs: [test, e2e-test]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm build
      
      - name: Package CLI binary
        run: pnpm package
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: zcu-build
          path: |
            dist/
            bin/
            packages/

  release:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build and package
        run: pnpm build && pnpm package
      
      - name: Publish to npm
        run: pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: ZCU ${{ github.ref }}
          body: |
            ## æ–°åŠŸèƒ½ What's New
            
            ### âœ¨ åŠŸèƒ½å¢å¼º Features
            - æ”¹è¿›çš„å¿«ç…§ç®¡ç†ç•Œé¢
            - å¢å¼ºçš„AIå·¥ä½œç©ºé—´éš”ç¦»
            - ä¼˜åŒ–çš„å†²çªè§£å†³æœºåˆ¶
            
            ### ğŸ› é”™è¯¯ä¿®å¤ Bug Fixes  
            - ä¿®å¤å¤§æ–‡ä»¶å¤„ç†æ€§èƒ½é—®é¢˜
            - è§£å†³è·¨å¹³å°å…¼å®¹æ€§é—®é¢˜
            
            ### ğŸ”§ æŠ€æœ¯æ”¹è¿› Technical Improvements
            - å‡çº§ä¾èµ–é¡¹ç‰ˆæœ¬
            - ä¼˜åŒ–æ„å»ºæµç¨‹
            - æ”¹è¿›é”™è¯¯å¤„ç†
            
            ## å®‰è£…å’Œå‡çº§ Installation & Upgrade
            
            ```bash
            # å…¨æ–°å®‰è£…
            npm install -g zcu
            
            # ä»æ—§ç‰ˆæœ¬å‡çº§
            npm update -g zcu
            ```
            
            ## ç ´åæ€§å˜æ›´ Breaking Changes
            
            æ— ç ´åæ€§å˜æ›´
            
            ## å®Œæ•´å˜æ›´æ—¥å¿—
            
            æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) è·å–è¯¦ç»†å˜æ›´ä¿¡æ¯ã€‚
```

### 8.1.2 å¤šå¹³å°æ‰“åŒ…ç­–ç•¥

```typescript
// build.config.ts - unbuildé…ç½®
export default defineBuildConfig([
  // CLIæ ¸å¿ƒåŒ…
  {
    name: 'zcu-core',
    entries: ['src/index'],
    outDir: 'dist',
    clean: true,
    declaration: true,
    rollup: {
      emitCJS: true,
      esbuild: {
        target: 'node16'
      }
    },
    externals: [
      'leveldown',
      'fsevents' // macOSç‰¹å®šä¾èµ–
    ]
  },
  
  // CLIäºŒè¿›åˆ¶
  {
    name: 'zcu-cli',
    entries: ['src/cli'],
    outDir: 'bin',
    clean: false,
    rollup: {
      emitCJS: true,
      inlineDynamicImports: true,
      esbuild: {
        target: 'node16',
        banner: '#!/usr/bin/env node'
      }
    }
  },
  
  // Web Dashboard
  {
    name: 'zcu-web',
    entries: ['src/web/index'],
    outDir: 'dist/web',
    rollup: {
      emitCJS: false,
      esbuild: {
        target: 'es2020',
        format: 'esm'
      }
    }
  }
])

// package.config.ts - å¤šå¹³å°æ‰“åŒ…
export const packageConfig = {
  targets: [
    {
      platform: 'win32',
      arch: 'x64',
      output: 'zcu-win-x64.exe'
    },
    {
      platform: 'darwin', 
      arch: 'x64',
      output: 'zcu-mac-x64'
    },
    {
      platform: 'darwin',
      arch: 'arm64', 
      output: 'zcu-mac-arm64'
    },
    {
      platform: 'linux',
      arch: 'x64',
      output: 'zcu-linux-x64'
    }
  ],
  
  // å¹³å°ç‰¹å®šé…ç½®
  platformSpecific: {
    win32: {
      icon: 'assets/icon.ico',
      productName: 'ZCU - Z Claude Undo',
      productDescription: 'Advanced undo/redo for Claude Code'
    },
    darwin: {
      icon: 'assets/icon.icns',
      category: 'public.app-category.developer-tools'
    },
    linux: {
      icon: 'assets/icon.png',
      desktop: {
        Name: 'ZCU',
        Comment: 'Advanced undo/redo for Claude Code',
        Categories: 'Development;'
      }
    }
  }
}
```

## 8.2 éƒ¨ç½²ç­–ç•¥

### 8.2.1 å®¹å™¨åŒ–éƒ¨ç½²

```dockerfile
# Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

# å¤åˆ¶åŒ…ç®¡ç†æ–‡ä»¶
COPY package.json pnpm-lock.yaml ./
COPY .npmrc ./

# å®‰è£…ä¾èµ–
RUN npm install -g pnpm
RUN pnpm install --frozen-lockfile

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN pnpm build

# ç”Ÿäº§é•œåƒ
FROM node:18-alpine AS runtime

WORKDIR /app

# å®‰è£…ç”Ÿäº§ä¾èµ–
COPY package.json pnpm-lock.yaml ./
RUN npm install -g pnpm
RUN pnpm install --prod --frozen-lockfile

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/bin ./bin

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S zcu
RUN adduser -S zcu -u 1001
USER zcu

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node bin/zcu.mjs --health-check

EXPOSE 3001

CMD ["node", "bin/zcu.mjs", "serve"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  zcu-server:
    build: .
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - ZCU_DATA_DIR=/data
      - ZCU_LOG_LEVEL=info
    volumes:
      - zcu_data:/data
      - zcu_logs:/app/logs
    healthcheck:
      test: ["CMD", "node", "bin/zcu.mjs", "--health-check"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    
  # å¯é€‰ï¼šRedisç¼“å­˜
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    restart: unless-stopped
    
  # å¯é€‰ï¼šç›‘æ§
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    restart: unless-stopped

volumes:
  zcu_data:
  zcu_logs:
  redis_data:
  prometheus_data:
```

### 8.2.2 äº‘æœåŠ¡éƒ¨ç½²

```typescript
// deploy/aws-lambda.ts - Lambdaéƒ¨ç½²é…ç½®
export const lambdaConfig = {
  functionName: 'zcu-api-handler',
  runtime: 'nodejs18.x',
  handler: 'dist/lambda.handler',
  memorySize: 1024,
  timeout: 30,
  
  environment: {
    NODE_ENV: 'production',
    ZCU_DATA_BUCKET: 'zcu-data-bucket',
    ZCU_LOG_LEVEL: 'info'
  },
  
  layers: [
    'arn:aws:lambda:us-east-1:123456789012:layer:zcu-dependencies:1'
  ],
  
  vpc: {
    securityGroupIds: ['sg-12345678'],
    subnetIds: ['subnet-12345678', 'subnet-87654321']
  }
}

// next.config.js - Next.js 15é…ç½®ï¼ˆUnoCSSé›†æˆï¼‰
import UnoCSS from '@unocss/next'

/** @type {import('next').NextConfig} */
const nextConfig = {
  // React 19 å’Œ Next.js 15 æ–°ç‰¹æ€§
  experimental: {
    // appDir åœ¨ Next.js 15 ä¸­å·²ç¨³å®šï¼Œä¸å†éœ€è¦
    serverExternalPackages: ['@zcu/core'], // æ›´æ–°çš„é…ç½®å
    turbo: {
      rules: {
        '*.svg': {
          loaders: ['@svgr/webpack'],
          as: '*.js',
        },
      },
    },
  },
  transpilePackages: ['@zcu/shared'],
  env: {
    ZCU_API_URL: process.env.ZCU_API_URL || 'http://localhost:3001',
  },
  // React 19 ä¼˜åŒ–
  compiler: {
    removeConsole: process.env.NODE_ENV === 'production',
  },
}

export default UnoCSS(nextConfig)

// deploy/vercel.ts - Verceléƒ¨ç½²é…ç½®  
export const vercelConfig = {
  name: 'zcu-web-dashboard',
  version: 2,
  
  builds: [
    {
      src: 'src/web/**/*',
      use: '@vercel/next'
    },
    {
      src: 'src/api/**/*',
      use: '@vercel/node'
    }
  ],
  
  routes: [
    {
      src: '/api/(.*)',
      dest: '/src/api/$1'
    },
    {
      src: '/(.*)',
      dest: '/src/web/$1'
    }
  ],
  
  env: {
    ZCU_API_URL: 'https://api.zcu.dev',
    NODE_ENV: 'production',
    UNOCSS_MODE: 'production'
  }
}
```

---
