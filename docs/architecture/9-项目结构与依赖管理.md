# 9. 项目结构与依赖管理

## 9.1 Monorepo架构

```
zcu/
├── packages/
│   ├── core/                   # 核心库
│   │   ├── src/
│   │   │   ├── storage/        # 存储层
│   │   │   ├── workspace/      # 工作空间管理
│   │   │   ├── operations/     # 操作引擎
│   │   │   └── types/          # 类型定义
│   │   └── package.json
│   ├── cli/                    # CLI界面
│   │   ├── src/
│   │   │   ├── commands/       # 命令实现
│   │   │   ├── ui/            # Ink组件
│   │   │   └── adapters/       # 适配器
│   │   └── package.json  
│   ├── web/                    # Web Dashboard
│   │   ├── src/
│   │   │   ├── pages/          # Next.js页面
│   │   │   ├── components/     # React组件
│   │   │   └── lib/           # 工具函数
│   │   └── package.json
│   ├── shared/                 # 共享组件库
│   │   ├── src/
│   │   │   ├── components/     # UI组件
│   │   │   ├── hooks/          # React Hooks
│   │   │   ├── utils/          # 工具函数
│   │   │   └── types/          # 共享类型
│   │   └── package.json
│   └── adapters/               # 平台适配器
│       ├── shadcn-ink/         # shadcn/ui Ink适配
│       ├── unocss-config/      # UnoCSS配置 (移除Tailwind兼容)
│       │   ├── shadcn-preset.ts          # shadcn/ui UnoCSS预设
│       │   ├── cli-preset.ts             # CLI专用预设
│       │   └── web-preset.ts             # Web专用预设
│       └── i18n-config/        # 国际化配置
├── apps/
│   ├── desktop/                # 桌面应用(Electron)
│   └── vscode-extension/       # VS Code扩展
├── tools/
│   ├── build/                  # 构建工具
│   ├── test/                   # 测试工具
│   └── deploy/                 # 部署脚本
├── docs/                       # 文档
├── examples/                   # 使用示例
└── scripts/                    # 项目脚本
```

## 9.2 依赖管理策略

### 9.2.1 package.json配置

```json
{
  "name": "zcu",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "packageManager": "pnpm@10.15.1",
  "description": "Z Claude Undo - Advanced undo/redo for Claude Code",
  "keywords": ["claude-code", "undo", "redo", "ai", "workspace", "shadcn", "unocss"],
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/your-org/zcu.git"
  },
  
  "workspaces": [
    "packages/*",
    "apps/*"
  ],
  
  "scripts": {
    "dev": "turbo run dev",
    "build": "turbo run build",
    "test": "turbo run test",
    "test:e2e": "turbo run test:e2e",
    "lint": "turbo run lint",
    "typecheck": "turbo run typecheck",
    "changeset": "changeset",
    "version": "changeset version",
    "release": "pnpm build && changeset publish"
  },
  
  "devDependencies": {
    "@changesets/cli": "^2.29.6",
    "@types/node": "^22.18.0",
    "@antfu/eslint-config": "^5.2.1",
    "@vitest/coverage-v8": "^3.2.4",
    "@vitest/ui": "^3.2.4",
    "eslint": "^9.34.0",
    "eslint-plugin-format": "^1.0.1",
    "prettier": "^3.3.3",
    "turbo": "^2.3.3",
    "typescript": "^5.9.2",
    "unbuild": "^3.6.1",
    "vitest": "^3.2.4"
  },
  
  "pnpm": {
    "overrides": {
      "@types/react": "^19.1.1",
      "@types/react-dom": "^19.1.1"
    },
    "peerDependencyRules": {
      "ignoreMissing": [
        "@types/react",
        "@types/react-dom"
      ]
    }
  }
}
```

### 9.2.2 pnpm-workspace.yaml 和 Catalog 配置

采用 catalog 管理依赖版本，实现集中化版本控制 (参考 haitai-solar-monorepo 模式)：

```yaml
# pnpm-workspace.yaml
packages:
  - packages/*
  - apps/*
  - tools/*
  - '!**/node_modules'
  
catalog:
  # React 生态系统
  'react': ^19.1.1
  'react-dom': ^19.1.1
  '@types/react': ^19.1.1
  '@types/react-dom': ^19.1.1
  
  # Next.js 和构建工具
  'next': ^15.5.2
  'typescript': ^5.9.2
  'unbuild': ^3.6.1
  'turbo': ^2.3.3
  'vite': ^6.0.11
  
  # ESLint 配置 (使用 @antfu/eslint-config)
  '@antfu/eslint-config': ^5.2.1
  'eslint': ^9.34.0
  'eslint-plugin-format': ^1.0.1
  
  # 测试框架
  'vitest': ^3.2.4
  '@vitest/coverage-v8': ^3.2.4
  '@vitest/ui': ^3.2.4
  
  # UnoCSS 相关
  'unocss': ^66.4.2
  '@unocss/next': ^66.4.2
  '@unocss/reset': ^66.4.2
  'unocss-preset-shadcn': ^0.3.2
  
  # UI 组件库
  '@radix-ui/react-slot': ^1.1.0
  '@radix-ui/react-avatar': ^1.1.1
  '@radix-ui/react-dialog': ^1.1.2
  '@radix-ui/react-dropdown-menu': ^2.1.2
  '@radix-ui/react-toast': ^1.2.2
  '@radix-ui/react-tooltip': ^1.1.3
  '@radix-ui/react-popover': ^1.1.2
  '@radix-ui/react-select': ^2.1.2
  '@radix-ui/react-tabs': ^1.1.1
  'lucide-react': ^0.473.0
  'class-variance-authority': ^0.7.1
  'clsx': ^2.1.1
  'tailwind-merge': ^2.6.0
  
  # 状态管理和工具
  'zustand': ^4.5.5
  'dayjs': ^1.11.13
  'semver': ^7.7.2
  'zod': ^3.24.1
  
  # 国际化
  'i18next': ^25.4.2
  'react-i18next': ^15.0.2
  'i18next-fs-backend': ^2.6.0
  
  # CLI 工具
  'ink': ^5.0.1
  'commander': ^12.1.0
  'chalk': ^5.3.0
  'enquirer': ^2.4.1
  'ora': ^8.2.0
  'figures': ^6.1.0
  
  # 系统工具
  '@types/node': ^22.18.0
  'level': ^8.0.1
  'simple-git': ^3.25.0
  'fs-extra': ^11.2.0
  
  # 版本管理
  '@changesets/cli': ^2.29.6
  
  # 包管理器
  'pnpm': ^10.15.1
  
onlyBuiltDependencies:
  - '@swc/core'
  - 'sharp'
  - 'level'
  - 'sqlite3'
```

**Catalog 使用方式：**

```json
// 在各个 package.json 中使用 catalog: 引用
{
  "dependencies": {
    "react": "catalog:",
    "next": "catalog:",
    "zod": "catalog:"
  },
  "devDependencies": {
    "@antfu/eslint-config": "catalog:",
    "vitest": "catalog:",
    "typescript": "catalog:"
  }
}
```

### 9.2.3 核心包依赖

```json
// packages/core/package.json
{
  "name": "@zcu/core",
  "version": "1.0.0",
  "type": "module",
  "main": "dist/index.mjs",
  "module": "dist/index.mjs", 
  "types": "dist/index.d.mts",
  "exports": {
    ".": {
      "import": "./dist/index.mjs",
      "types": "./dist/index.d.mts"
    },
    "./storage": {
      "import": "./dist/storage.mjs",
      "types": "./dist/storage.d.mts"  
    },
    "./workspace": {
      "import": "./dist/workspace.mjs",
      "types": "./dist/workspace.d.mts"
    }
  },
  
  "dependencies": {
    "level": "catalog:",
    "simple-git": "catalog:",
    "semver": "catalog:",
    "dayjs": "catalog:",
    "zod": "catalog:",
    "fs-extra": "catalog:",
    "crypto": "^1.0.1"
  },
  
  "peerDependencies": {
    "typescript": ">=5.0.0"
  }
}
```

```json
// packages/shared/package.json
{
  "name": "@zcu/shared",
  "version": "1.0.0", 
  "type": "module",
  "main": "dist/index.mjs",
  "types": "dist/index.d.mts",
  "exports": {
    ".": "./dist/index.mjs",
    "./components": "./dist/components.mjs",
    "./hooks": "./dist/hooks.mjs",
    "./utils": "./dist/utils.mjs"
  },
  
  "dependencies": {
    "@zcu/core": "workspace:*",
    "react": "catalog:",
    "zustand": "catalog:",
    "i18next": "catalog:",
    "react-i18next": "catalog:",
    "@radix-ui/react-slot": "catalog:",
    "class-variance-authority": "catalog:",
    "clsx": "catalog:",
    "tailwind-merge": "catalog:"
  },
  
  "peerDependencies": {
    "react": ">=19.1.1"
  }
}
```

### 9.2.3 UI组件包依赖

```json
// packages/cli/package.json
{
  "name": "@zcu/cli",
  "version": "1.0.0",
  "type": "module", 
  "bin": {
    "zcu": "./bin/zcu.mjs"
  },
  
  "dependencies": {
    "@zcu/core": "workspace:*",
    "@zcu/shared": "workspace:*",
    "ink": "catalog:",
    "react": "catalog:",
    "commander": "catalog:",
    "chalk": "catalog:",
    "enquirer": "catalog:",
    "ora": "catalog:",
    "figures": "catalog:",
    "ink-select-input": "^6.0.0",
    "ink-text-input": "^6.0.0",
    "ink-spinner": "^5.0.0"
  }
}
```

```json
// packages/web/package.json
{
  "name": "@zcu/web",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "next dev",
    "build": "next build", 
    "start": "next start"
  },
  
  "dependencies": {
    "@zcu/core": "workspace:*",
    "@zcu/shared": "workspace:*", 
    "next": "catalog:",
    "react": "catalog:",
    "react-dom": "catalog:",
    "@radix-ui/react-avatar": "catalog:",
    "@radix-ui/react-slot": "catalog:",
    "@radix-ui/react-dialog": "catalog:",
    "@radix-ui/react-dropdown-menu": "catalog:",
    "@radix-ui/react-toast": "catalog:",
    "@radix-ui/react-tooltip": "catalog:",
    "@radix-ui/react-popover": "catalog:",
    "@radix-ui/react-select": "catalog:",
    "@radix-ui/react-tabs": "catalog:",
    "class-variance-authority": "catalog:",
    "clsx": "catalog:",
    "lucide-react": "catalog:",
    "tailwind-merge": "catalog:"
  },
  
  "devDependencies": {
    "@types/react": "catalog:",
    "@types/react-dom": "catalog:",
    "@unocss/next": "catalog:",
    "unocss": "catalog:",
    "unocss-preset-shadcn": "catalog:"
  }
}
```

---
