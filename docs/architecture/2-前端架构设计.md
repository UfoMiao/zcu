# 2. 前端架构设计

## 2.1 双重渲染架构

### 2.1.1 架构设计理念

ZCU采用创新的React双重渲染架构，通过共享组件库实现CLI（Ink）和Web的统一开发体验。这种设计避免了重复开发，确保功能一致性，同时充分利用各平台特性优势。

```typescript
// 双重渲染架构核心设计
interface RenderTarget {
  type: 'cli' | 'web';
  renderer: InkRenderer | WebRenderer;
  platform: PlatformAdapter;
}

// 共享组件抽象
interface SharedComponent<TProps> {
  businessLogic: (props: TProps) => BusinessState;
  cliRenderer: (state: BusinessState) => InkElement;
  webRenderer: (state: BusinessState) => ReactElement;
}
```

### 2.1.2 组件映射策略

```typescript
// 组件映射配置
export const componentMapping = {
  SnapshotList: {
    shared: useSnapshotListLogic,
    cli: InkSnapshotList,
    web: WebSnapshotList,
    props: SnapshotListProps
  },
  ConflictResolver: {
    shared: useConflictResolverLogic,
    cli: InkConflictDialog,
    web: WebConflictModal,
    props: ConflictResolverProps
  },
  WorkspaceMonitor: {
    shared: useWorkspaceLogic,
    cli: InkWorkspaceStatus,
    web: WebWorkspacePanel,
    props: WorkspaceMonitorProps
  }
} as const;
```

## 2.2 UI组件库架构

### 2.2.1 设计系统集成

ZCU集成UnoCSS v0.63.4+作为原子化CSS框架，与shadcn/ui组件库深度整合，创建统一的设计语言系统。

> **重要说明**：ZCU项目完全采用UnoCSS替代Tailwind CSS，两者不可同时存在。UnoCSS提供了更好的性能（零运行时开销）、更小的包体积和更灵活的配置选项。通过`unocss-preset-shadcn`预设，实现了与shadcn/ui组件的完美兼容。

```typescript
// UnoCSS配置 - ZCU定制 (v0.63.4+)
import { defineConfig, presetUno, presetAttributify, presetTypography, presetWebFonts, transformerDirectives, transformerVariantGroup } from 'unocss'
import { presetShadcn } from 'unocss-preset-shadcn'

export default defineConfig({
  presets: [
    presetUno(),
    presetAttributify(),
    presetTypography(),
    presetWebFonts({
      fonts: {
        sans: 'Inter:400,500,600,700',
        mono: ['JetBrains Mono', 'Fira Code', 'Consolas']
      }
    }),
    // shadcn/ui预设，确保兼容性
    presetShadcn({
      color: 'neutral',
      radius: 0.75
    })
  ],
  transformers: [
    transformerDirectives(),
    transformerVariantGroup()
  ],
  theme: {
    colors: {
      // ZCU品牌色系 - 与shadcn/ui兼容
      primary: {
        50: '#f0f9ff',
        100: '#e0f2fe',
        200: '#bae6fd',
        300: '#7dd3fc',
        400: '#38bdf8',
        500: '#0ea5e9',
        600: '#0284c7',
        700: '#0369a1',
        800: '#075985',
        900: '#0c4a6e',
        950: '#082f49'
      },
      // 状态色彩 - shadcn/ui标准
      success: {
        DEFAULT: '#10b981',
        foreground: '#ffffff'
      },
      warning: {
        DEFAULT: '#f59e0b',
        foreground: '#ffffff'
      },
      destructive: {
        DEFAULT: '#ef4444',
        foreground: '#ffffff'
      },
      // CLI专用色彩 (ANSI兼容)
      cli: {
        text: '#f1f5f9',
        highlight: '#0ea5e9',
        dim: '#64748b',
        success: '#10b981',
        warning: '#f59e0b',
        error: '#ef4444'
      }
    },
    fontFamily: {
      mono: ['JetBrains Mono', 'Fira Code', 'Consolas', 'SF Mono', 'Monaco', 'monospace'],
      sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'sans-serif']
    },
    borderRadius: {
      lg: '0.75rem',
      md: '0.5rem',
      sm: '0.25rem'
    }
  },
  shortcuts: {
    // ZCU快捷样式类 - shadcn/ui兼容
    'zcu-btn-primary': 'bg-primary-500 text-primary-foreground hover:bg-primary-600 px-4 py-2 rounded-md font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50',
    'zcu-btn-secondary': 'bg-secondary text-secondary-foreground hover:bg-secondary/80 px-4 py-2 rounded-md font-medium transition-colors',
    'zcu-btn-destructive': 'bg-destructive text-destructive-foreground hover:bg-destructive/90 px-4 py-2 rounded-md font-medium transition-colors',
    'zcu-card': 'rounded-lg border bg-card text-card-foreground shadow-sm',
    'zcu-input': 'flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50'
  },
  content: {
    filesystem: ['./src/**/*.{js,ts,jsx,tsx}', './components/**/*.{js,ts,jsx,tsx}']
  }
})
```

### 2.2.2 shadcn/ui组件适配

#### Web环境标准实现
```typescript
// shadcn/ui Web组件 - UnoCSS兼容版本
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import { Badge } from '@/components/ui/badge'
import { Clock, FileText } from 'lucide-react'

export const WebSnapshotCard: React.FC<SnapshotCardProps> = ({ snapshot, onRestore }) => {
  return (
    <Card className="zcu-card hover:shadow-lg transition-shadow duration-200">
      <CardHeader className="pb-3">
        <CardTitle className="text-base font-semibold flex items-center gap-2">
          <FileText className="h-4 w-4 text-primary" />
          {snapshot.description}
        </CardTitle>
        <div className="flex items-center gap-2 text-sm text-muted-foreground">
          <Clock className="h-3 w-3" />
          {formatTimestamp(snapshot.timestamp)}
          <Badge variant="secondary" className="ml-auto">
            {snapshot.filesCount} 个文件
          </Badge>
        </div>
      </CardHeader>
      <CardContent className="pt-0">
        <div className="flex justify-between items-center">
          <div className="text-xs text-muted-foreground">
            ID: {snapshot.id.slice(0, 8)}...
          </div>
          <Button 
            onClick={() => onRestore(snapshot.id)} 
            size="sm"
            className="zcu-btn-primary"
          >
            恢复快照
          </Button>
        </div>
      </CardContent>
    </Card>
  )
}
```

#### CLI环境适配方案
```typescript
// shadcn/ui CLI适配层 - 增强版本
import { Box, Text, Spacer } from 'ink'
import { useState, useCallback } from 'react'
import figures from 'figures'
import chalk from 'chalk'

// 增强的shadcn/ui组件Ink适配器
export const adaptShadcnForInk = {
  Button: ({ children, onClick, variant = 'default', size = 'default', disabled = false }: ButtonProps) => {
    const [isHovered, setIsHovered] = useState(false)
    
    const variants = {
      default: { bg: 'bgWhite', fg: 'black', hoverBg: 'bgGray' },
      primary: { bg: 'bgBlue', fg: 'white', hoverBg: 'bgBlueBright' },
      destructive: { bg: 'bgRed', fg: 'white', hoverBg: 'bgRedBright' },
      secondary: { bg: 'bgGray', fg: 'white', hoverBg: 'bgWhite' }
    }
    
    const sizes = {
      sm: { padding: 0, prefix: ' ', suffix: ' ' },
      default: { padding: 1, prefix: ' ', suffix: ' ' },
      lg: { padding: 1, prefix: '  ', suffix: '  ' }
    }
    
    const style = variants[variant]
    const sizeStyle = sizes[size]
    
    return (
      <Box borderStyle="single" paddingX={sizeStyle.padding}>
        <Text 
          color={disabled ? 'gray' : style.fg}
          backgroundColor={disabled ? 'bgGray' : (isHovered ? style.hoverBg : style.bg)}
          bold={!disabled}
        >
          {sizeStyle.prefix}{figures.pointer} {children}{sizeStyle.suffix}
        </Text>
      </Box>
    )
  },
  
  Card: ({ children, className }: CardProps) => (
    <Box 
      borderStyle="round" 
      padding={1} 
      marginY={1}
      borderColor="gray"
    >
      <Box flexDirection="column">
        {children}
      </Box>
    </Box>
  ),
  
  CardHeader: ({ children }: CardHeaderProps) => (
    <Box marginBottom={1}>
      {children}
    </Box>
  ),
  
  CardContent: ({ children }: CardContentProps) => (
    <Box>
      {children}
    </Box>
  ),
  
  Badge: ({ children, variant = 'default' }: BadgeProps) => {
    const variants = {
      default: 'bgGray',
      secondary: 'bgBlue',
      destructive: 'bgRed',
      outline: 'gray'
    }
    
    return (
      <Text 
        backgroundColor={variants[variant]}
        color={variant === 'outline' ? 'gray' : 'white'}
        bold
      >
        [{children}]
      </Text>
    )
  },
  
  Dialog: ({ children, open }: DialogProps) => {
    if (!open) return null
    return (
      <Box 
        borderStyle="double" 
        padding={2}
        borderColor="blue"
        justifyContent="center"
        alignItems="center"
      >
        <Box maxWidth={60}>
          {children}
        </Box>
      </Box>
    )
  }
}

// CLI适配的快照卡片 - 增强版本
export const InkSnapshotCard: React.FC<SnapshotCardProps> = ({ snapshot, onRestore }) => {
  const AdaptedCard = adaptShadcnForInk.Card
  const AdaptedButton = adaptShadcnForInk.Button
  const AdaptedBadge = adaptShadcnForInk.Badge
  
  return (
    <AdaptedCard>
      <Box marginBottom={1}>
        <Text color="blue" bold>
          {figures.folder} {snapshot.description}
        </Text>
      </Box>
      
      <Box marginBottom={1}>
        <Text dimColor>
          {figures.clock} {formatTimestamp(snapshot.timestamp)}
        </Text>
        <Spacer />
        <AdaptedBadge variant="secondary">
          {snapshot.filesCount} 文件
        </AdaptedBadge>
      </Box>
      
      <Box>
        <Text dimColor>
          ID: {snapshot.id.slice(0, 8)}...
        </Text>
        <Spacer />
        <AdaptedButton 
          onClick={() => onRestore(snapshot.id)} 
          variant="primary"
          size="sm"
        >
          恢复快照
        </AdaptedButton>
      </Box>
    </AdaptedCard>
  )
}
```

## 2.3 国际化架构

### 2.3.1 i18next集成方案

参考ZCF项目的成功实践，ZCU采用i18next作为国际化解决方案，支持动态语言切换和资源懒加载。

```typescript
// i18n配置 - 参考ZCF实现
import i18n from 'i18next'
import Backend from 'i18next-fs-backend'
import { initReactI18next } from 'react-i18next'

export const initI18n = async () => {
  await i18n
    .use(Backend)
    .use(initReactI18next)
    .init({
      lng: 'zh-CN', // 默认中文
      fallbackLng: 'en',
      
      backend: {
        loadPath: './locales/{{lng}}/{{ns}}.json'
      },
      
      ns: ['common', 'ui', 'errors', 'cli'],
      defaultNS: 'common',
      
      interpolation: {
        escapeValue: false
      },
      
      react: {
        useSuspense: false // CLI环境兼容
      }
    })
}

// 命名空间组织
export const i18nNamespaces = {
  common: {
    snapshot: '快照',
    workspace: '工作空间',
    conflict: '冲突',
    operation: '操作'
  },
  ui: {
    buttons: {
      restore: '恢复',
      delete: '删除',
      confirm: '确认',
      cancel: '取消'
    },
    messages: {
      success: '操作成功',
      error: '操作失败',
      loading: '加载中...'
    }
  },
  cli: {
    prompts: {
      selectSnapshot: '请选择要恢复的快照',
      confirmRestore: '确认要恢复此快照吗？'
    }
  }
} as const;
```

### 2.3.2 CLI和Web双环境i18n

```typescript
// CLI环境国际化Hook
export const useCliI18n = () => {
  const { t } = useTranslation(['common', 'cli'])
  
  // CLI特有的格式化函数
  const formatCliMessage = (key: string, options?: any) => {
    const message = t(key, options)
    // CLI消息添加前缀图标
    if (key.includes('error')) return `❌ ${message}`
    if (key.includes('success')) return `✅ ${message}`
    if (key.includes('warning')) return `⚠️  ${message}`
    return message
  }
  
  return { t, formatCliMessage }
}

// Web环境国际化Hook
export const useWebI18n = () => {
  const { t, i18n } = useTranslation(['common', 'ui'])
  
  // Web特有的语言切换
  const switchLanguage = async (lng: string) => {
    await i18n.changeLanguage(lng)
    // 持久化语言设置
    localStorage.setItem('zcu-language', lng)
  }
  
  return { t, switchLanguage, currentLang: i18n.language }
}
```

---
