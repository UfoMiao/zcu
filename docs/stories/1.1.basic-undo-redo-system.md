# Story 1.1: 基础Undo/Redo系统

## Status
Approved

## Story
**As a** Claude Code用户,  
**I want** 快速撤销AI的修改操作,  
**so that** 在AI修改出现问题时快速恢复

## Acceptance Criteria
1. ✅ 快照创建时间≤3秒
2. ✅ 支持项目大小≤100MB
3. ✅ 内存占用≤50MB
4. ✅ 数据丢失率=0%
5. ✅ 支持至少20个快照点
6. 支持文件级和项目级的回滚操作
7. 基于LevelDB的轻量级存储(≤200KB)
8. Shadow Repository文件快照管理
9. 操作历史链式追踪

## Tasks / Subtasks

- [ ] Task 1: 初始化项目基础架构 (AC: 1, 2, 3)
  - [ ] 创建Monorepo项目结构按照架构规范
  - [ ] 配置package.json和pnpm工作空间
  - [ ] 设置TypeScript配置和构建工具(unbuild)
  - [ ] 创建packages/core核心库基础结构

- [ ] Task 2: 实现LevelDB存储层 (AC: 4, 7)
  - [ ] 创建LevelDB键值架构实现
  - [ ] 实现工作空间、操作、冲突的存储schema
  - [ ] 实现存储管理器StorageManager类
  - [ ] 创建存储层单元测试

- [ ] Task 3: 实现Shadow Repository管理 (AC: 8, 9)
  - [ ] 创建ShadowRepositoryManager类
  - [ ] 实现Git仓库初始化和快照创建
  - [ ] 实现增量快照存储机制
  - [ ] 创建Repository管理单元测试

- [ ] Task 4: 实现操作历史追踪 (AC: 9)
  - [ ] 创建Operation和OperationChain类型
  - [ ] 实现操作记录和链式追踪逻辑
  - [ ] 实现操作回滚机制
  - [ ] 创建操作追踪单元测试

- [ ] Task 5: 实现基础Undo/Redo引擎 (AC: 1, 5, 6)
  - [ ] 创建UndoRedoEngine核心类
  - [ ] 实现文件级回滚功能
  - [ ] 实现项目级回滚功能  
  - [ ] 实现快照点管理(至少20个)
  - [ ] 创建Undo/Redo引擎单元测试

## Dev Notes

### Previous Story Insights
这是第一个故事，没有前序故事的经验。

### 项目结构信息
[Source: architecture/9-项目结构与依赖管理.md#91-monorepo架构]

项目采用Monorepo架构，主要结构：
```
zcu/
├── packages/
│   ├── core/                   # 核心库 (本故事主要开发区域)
│   │   ├── src/
│   │   │   ├── storage/        # 存储层实现
│   │   │   ├── workspace/      # 工作空间管理
│   │   │   ├── operations/     # 操作引擎
│   │   │   └── types/          # 类型定义
│   │   └── package.json
```

### 存储架构技术细节
[Source: architecture/4-存储架构设计.md#411-分层存储设计]

**LevelDB键值设计架构:**
```typescript
export const LevelDBSchema = {
  // 工作空间相关
  workspace: {
    active: (aiId: string) => `workspace:${aiId}:active`,
    metadata: (id: string) => `workspace:${id}:metadata`,
    operations: (id: string) => `workspace:${id}:operations`,
    state: (id: string) => `workspace:${id}:state`
  },
  
  // 操作记录
  operation: {
    latest: (aiId: string) => `operation:${aiId}:latest`,
    history: (aiId: string) => `operation:${aiId}:history`,
    metadata: (id: string) => `operation:${id}:metadata`
  },
  
  // 安全相关
  safety: {
    level: (operationId: string) => `safety:${operationId}:level`,
    rollback: (id: string) => `safety:${id}:rollback`
  }
}
```

**Shadow Repository实现:**
[Source: architecture/4-存储架构设计.md#412-shadow-repository实现]
- Shadow仓库路径: `{projectPath}/.zcu/shadow`
- 使用simple-git库进行Git操作
- 实现增量快照机制避免重复存储

### 核心API架构
[Source: architecture/3-后端架构设计.md#311-微服务架构设计]

核心服务接口定义:
```typescript
interface ZCUCoreService {
  // Undo/Redo引擎 (本故事重点)
  undoEngine: UndoRedoEngine;
  // 快照管理器 (本故事重点)
  snapshotManager: SnapshotManager;
}
```

### 核心依赖包要求
[Source: architecture/9-项目结构与依赖管理.md#923-核心包依赖]
- LevelDB相关: level
- Git操作: simple-git
- 构建工具: unbuild
- TypeScript支持: typescript
- 测试框架: vitest

### 性能要求
[Source: prd/2-功能需求.md#211-基础undoredo系统]
- 快照创建时间 ≤ 3秒
- 支持项目大小 ≤ 100MB  
- 内存占用 ≤ 50MB
- LevelDB存储 ≤ 200KB
- 支持至少20个快照点
- 数据丢失率 = 0%

### Testing
[Source: architecture/10-测试策略与质量保证.md#1011-测试金字塔]
- **测试框架**: Vitest
- **测试文件位置**: `packages/core/src/__tests__/`
- **覆盖率要求**: 核心功能模块≥95%
- **测试类型**: 单元测试为主，集成测试覆盖存储层
- **测试标准**: 每个类和函数都需要对应测试文件
- **模拟策略**: 文件系统和Git操作需要mock

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-03 | 1.0 | Initial story creation | SM Agent |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References  
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_